<!doctype html>
<html lang="en" prefix="og: http://ogp.me/ns#">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Apache MetaModel | APOTHEM
</title>
  <link rel="canonical" href="https://apothem.blog/apache-metamodel.html">

    <link rel="icon" type="image/x-icon" href="https://apothem.blog/favicon.ico">

  <link rel="stylesheet" href="https://apothem.blog/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://apothem.blog/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://apothem.blog/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://apothem.blog/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://apothem.blog/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://apothem.blog/feeds/{slug}.atom.xml">  
  <meta name="description" content="It's a few years now since I've got the "polyglot persistence" bug, first out of interest, then out of necessity. Given the abundance of data models and storage technologies available today, it is crucial to be aware of the strengths and weaknesses of each solution; furthermore, more often than not â€¦">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="https://apothem.blog/">
        <img class="img-fluid rounded" src=https://apothem.blog/images/profile.svg width=180 alt="APOTHEM">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="https://apothem.blog/">APOTHEM</a></h1>
      <p class="text-muted">Apache Project(s) of the month</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="https://projects.apache.org" target="_blank">projects.apache.org</a></li>
              <li class="list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a href="https://apothem.blog/pages/about.html">About</a></li>
            <li class="list-inline-item"><a href="https://apothem.blog/pages/faq.html">FAQ</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/nvitucci/apothem" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-twitter" href="https://twitter.com/nvitucci" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-rss" href="feeds/all.atom.xml" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h2>  Apache MetaModel
</h2>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2019-05-31T00:00:00+01:00">
          <i class="fa fa-clock-o"></i>
          Fri 31 May 2019
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="https://apothem.blog/category/projects.html">projects</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-files-o"></i>
              <a href="https://apothem.blog/tag/big-data.html">#Big Data</a>,               <a href="https://apothem.blog/tag/library.html">#library</a>,               <a href="https://apothem.blog/tag/database.html">#database</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>It's a few years now since I've got the "<a href="https://martinfowler.com/bliki/PolyglotPersistence.html">polyglot persistence</a>" bug, first out of interest, then out of necessity. Given the abundance of data models and storage technologies available today, it is crucial to be aware of the strengths and weaknesses of each solution; furthermore, more often than not, an architecture that integrates several types of solutions is desirable or needed.</p>
<p>Leaving architectural questions aside, the main question in this polyglot scenario is: how to read and interpret data from disparate data sources in a reliable and uniform fashion? Is it better to create a data lake out of all the sources, or to take a federated approach where every query is dispatched to its appropriate database? The Apache project we will work with today, <a href="https://metamodel.apache.org/">MetaModel</a>, aims at providing tools to deal with such challenges.</p>
<h3>Main concepts</h3>
<p>Apache MetaModel provides <em>"a common interface for discovery, exploration of metadata and querying of different types of data sources"</em>, which means that, through the use of concepts such as <em>datasets</em>, <em>tables</em>, and <em>columns</em>, it exposes a basic abstraction common to all the data sources it can connect to; such abstract data model can then be queried using SQL as an "interlanguage". It is important to note that, as stated on the website, <em>"MetaModel <em>isn't</em> a data mapping framework"</em>; in other words its main intended usage is not to integrate different terminologies within the same domain, but rather to make it easy to add new datasources and to maximize the usage of metadata.</p>
<p>MetaModel is not the only library to provide tools for data integration. A similar approach is offered by other Apache projects such as <a href="https://spark.apache.org/">Spark</a> or <a href="https://drill.apache.org/">Drill</a>, but MetaModel might be better suited than such Big Data tools in scenarios where the main challenge is the diversity in the data and the schema variability rather than the scale; it can be plugged into an existing project with no additional setup and it offers many convenience methods to start using data sources (including plain CSV, JSON and XML files!) right away. Now let's see how to include MetaModel in a project, along with a few examples.</p>
<p>(Note: in some sections of this article I will make use of Docker for convenience. If you don't want to use Docker at the moment, you can just skip those sections; otherwise, make sure to <a href="https://docs.docker.com/install/">install it</a> in order to follow.)</p>
<h3>Setup</h3>
<p>The best way to get started with MetaModel is to include it as a Maven dependency. If you use an IDE such as Eclipse or IntelliJ, all you need to do is to create a new <code>apache-metamodel-example</code> Maven project; otherwise, you can have a look <a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">here</a> to get an idea of how to install and work with Maven. In any case, as usual you will find a fully working project on the <a href="https://github.com/nvitucci/apothem-resources">associated repository</a> under the <code>apache-metamodel</code> folder.</p>
<p>The content of the <code>pom.xml</code> file should look like the following:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

     <span class="nt">&lt;groupId&gt;</span>groupId<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>apache-metamodel-example<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

     <span class="nt">&lt;dependencies&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.apache.metamodel<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>MetaModel-full<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;version&gt;</span>5.3.0<span class="nt">&lt;/version&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
     <span class="nt">&lt;/dependencies&gt;</span>
 <span class="nt">&lt;/project&gt;</span>
</pre></div>


<p>Once the <code>pom.xml</code> file is saved, your IDE should download all the needed dependencies automatically; if you are doing everything manually, you can run the following command to trigger a first build:</p>
<div class="highlight"><pre><span></span>$ mvn package
</pre></div>


<p>Now let's create a new Java file called <code>MetaModelExample.java</code> with the following content:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.metamodel.data.DataSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.metamodel.data.Row</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetaModelExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="n">MetaModelExample</span> <span class="n">example</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetamodelExample</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>If you don't get any errors in the imports, the project is set up correctly.</p>
<h3>Examples</h3>
<p>We can now start to add a few different data sources to explore MetaModel's capabilities.</p>
<h4>CSV files</h4>
<p>Let's start with a simple CSV file. We can manually create an <code>example.csv</code> file under <code>/tmp</code> with the following content:</p>
<div class="highlight"><pre><span></span>project,language,completed
Project1,Java,true
Project2,Java,false
Project3,Python,true
</pre></div>


<p>Let's add the following method to the <code>MetaModelExample</code> class:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processCsv</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">DataContext</span> <span class="n">dataContext</span> <span class="o">=</span> <span class="n">DataContextFactory</span><span class="o">.</span><span class="na">createCsvDataContext</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">tableNames</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableNames</span><span class="o">();</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">toArray</span><span class="o">()));</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">table</span> <span class="o">=</span> <span class="n">tableNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

    <span class="n">DataSet</span> <span class="n">dataSet</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">query</span><span class="o">()</span>
            <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">table</span><span class="o">)</span>
            <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&quot;project&quot;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;language&quot;</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="s">&quot;Java&quot;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="s">&quot;completed&quot;</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
            <span class="o">.</span><span class="na">execute</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">r</span><span class="o">:</span> <span class="n">dataSet</span><span class="o">.</span><span class="na">toRows</span><span class="o">())</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValues</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>


<p>and then a call to this method within the main:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">MetaModelExample</span> <span class="n">example</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetamodelExample</span><span class="o">();</span>

<span class="n">example</span><span class="o">.</span><span class="na">processCsv</span><span class="o">(</span><span class="s">&quot;/tmp/example.csv&quot;</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>


<p>If we run the main method, we will get the following output:</p>
<div class="highlight"><pre><span></span>[example.csv, default_table]
[Project2]
</pre></div>


<p>What have we just done?</p>
<ul>
<li>We created a <code>DataContext</code> (more specifically, a <code>CsvDataContext</code>) wrapping the CSV file.</li>
<li>We extracted the names of all the tables from the default schema and printed them; since the data source is a single file, the default schema is the only available schema and there is only one table (the second one being a convenience <code>default_table</code> alias).</li>
<li>We ran a SQL query on the first table: we selected the <code>project</code> column from the rows where the <code>language</code> is <code>Java</code> and <code>completed</code> is <code>false</code>.</li>
<li>We printed the result of the query.</li>
</ul>
<p>So, in the end, we ran a SQL query on a CSV file! Perhaps even more interestingly, we can update the file with some update instructions by replacing the <code>DataContext</code> class with <code>UpdateableDataContext</code> and then adding the following lines:</p>
<div class="highlight"><pre><span></span><span class="n">dataContext</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="k">new</span> <span class="n">UpdateScript</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">UpdateCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">callback</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;completed&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;language&quot;</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="s">&quot;Java&quot;</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
        <span class="n">callback</span><span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="n">table</span><span class="o">)</span>
                <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;project&quot;</span><span class="o">,</span> <span class="s">&quot;Project4&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;language&quot;</span><span class="o">,</span> <span class="s">&quot;Java&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;completed&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>


<p>If we run again the previous query, we'll see that the file has been updated and <code>Project2</code> is no longer listed, while <code>Project4</code> is. Neat!</p>
<h4>XLSX files</h4>
<p>Now let's look at a slightly more complex example. Spreadsheets can contain more than one table, which makes them closer to a relational database; MetaModel can use XLSX (<a href="https://en.wikipedia.org/wiki/Office_Open_XML">Office Open XML</a> Workbook) files, which can be read and saved with open source tools such as LibreOffice and OpenOffice. You can find an example file on the repo, or create your own one. All we need to do is to add a method such as this one:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processSpreadsheet</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">DataContext</span> <span class="n">dataContext</span> <span class="o">=</span> <span class="n">DataContextFactory</span><span class="o">.</span><span class="na">createExcelDataContext</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sheetNames</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableNames</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">sheetNames</span><span class="o">.</span><span class="na">toArray</span><span class="o">()));</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">sheetName</span><span class="o">:</span> <span class="n">sheetNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Column</span><span class="o">&gt;</span> <span class="n">sheetColumns</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableByName</span><span class="o">(</span><span class="n">sheetName</span><span class="o">).</span><span class="na">getColumns</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Column</span> <span class="n">col</span><span class="o">:</span> <span class="n">sheetColumns</span><span class="o">)</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">col</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

        <span class="n">DataSet</span> <span class="n">content</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">query</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">sheetName</span><span class="o">).</span><span class="na">selectAll</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">r</span><span class="o">:</span> <span class="n">content</span><span class="o">.</span><span class="na">toRows</span><span class="o">())</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValues</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>and include it in the main method as we did with the previous example. The output will show the name of all the sheets and, for each sheet, the names of its columns and its data. But there is more! Since in this example the first column of each sheet represents the ID of a customer, we can perform a join between the two sheets by adding the following lines:</p>
<div class="highlight"><pre><span></span><span class="n">DataSet</span> <span class="n">joined</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">query</span><span class="o">()</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">sheetNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
        <span class="o">.</span><span class="na">innerJoin</span><span class="o">(</span><span class="n">sheetNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="na">on</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;id&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&quot;Names.surname&quot;</span><span class="o">,</span> <span class="s">&quot;Products.amount&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">r</span><span class="o">:</span> <span class="n">joined</span><span class="o">.</span><span class="na">toRows</span><span class="o">())</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValues</span><span class="o">()));</span>
</pre></div>


<p>and the output will show the selected columns from the joined table.</p>
<h4>JSON files</h4>
<p>So far we have looked at tabular data, but what if we have data structured in a different format such as JSON? We may need to make some compromise between the expressivity of a non-relational model and the ease of use of a relational model, so in some cases we will need to "flatten out" some internal fields. Given instead a simple (and quite common) case, where the file is an array containing objects with the same fields like the following:</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>we can write code similar to what we already wrote before and run SQL queries on JSON files:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processJson</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">DataContext</span> <span class="n">dataContext</span> <span class="o">=</span> <span class="n">DataContextFactory</span><span class="o">.</span><span class="na">createJsonDataContext</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">tableNames</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableNames</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">toArray</span><span class="o">()));</span>

    <span class="n">DataSet</span> <span class="n">dataSet</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">query</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
            <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">gte</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
            <span class="o">.</span><span class="na">execute</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">r</span><span class="o">:</span> <span class="n">dataSet</span><span class="o">.</span><span class="na">toRows</span><span class="o">())</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValues</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>


<h4>Databases</h4>
<p>By now we have understood how to "enhance" static files with querying capabilities, but what if we want to connect to a real datastore such as SQLite, PostgreSQL or MongoDB?</p>
<p>MetaModel provides connectors for a wide variety of databases, including a generic JDBC connector and a specific connector for MongoDB, which support schema creation and inserts/updates as well. Let's see an example with MongoDB:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectToMongo</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">UpdateableDataContext</span> <span class="n">dataContext</span> <span class="o">=</span> <span class="n">DataContextFactory</span><span class="o">.</span><span class="na">createMongoDbDataContext</span><span class="o">(</span>
            <span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">27017</span><span class="o">,</span> <span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">tableNames</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableNames</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">dataContext</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="k">new</span> <span class="n">UpdateScript</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">UpdateCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;mytable&quot;</span><span class="o">;</span>

                <span class="n">callback</span><span class="o">.</span><span class="na">createTable</span><span class="o">(</span><span class="n">callback</span><span class="o">.</span><span class="na">getDataContext</span><span class="o">().</span><span class="na">getDefaultSchema</span><span class="o">(),</span> <span class="n">table</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">).</span><span class="na">ofType</span><span class="o">(</span><span class="n">ColumnType</span><span class="o">.</span><span class="na">VARCHAR</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">).</span><span class="na">ofType</span><span class="o">(</span><span class="n">ColumnType</span><span class="o">.</span><span class="na">CHAR</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">execute</span><span class="o">();</span>

                <span class="n">callback</span><span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span> <span class="s">&quot;red&quot;</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">,</span> <span class="s">&quot;L&quot;</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
                <span class="n">callback</span><span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span> <span class="s">&quot;yellow&quot;</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">,</span> <span class="s">&quot;S&quot;</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="n">tableNames</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">getDefaultSchema</span><span class="o">().</span><span class="na">getTableNames</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">toArray</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>


<p>In this example, we create a connection to a MongoDB instance running on <code>localhost:27017</code> and we connect to the <code>test</code> database (which might not exist yet); then, we get the list of "tables" (MongoDB collections) and, if none is found, we create a new one called <code>mytable</code> with "columns" (MongoDB document fields) <code>color</code> and <code>size</code>; finally, we insert two example "records" (MongoDB documents) in the newly created collections. In order to make sure that this works, we can add a query section like in the previous examples:</p>
<div class="highlight"><pre><span></span><span class="n">DataSet</span> <span class="n">dataSet</span> <span class="o">=</span> <span class="n">dataContext</span><span class="o">.</span><span class="na">query</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">tableNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
        <span class="o">.</span><span class="na">selectAll</span><span class="o">()</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&quot;S&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">r</span><span class="o">:</span> <span class="n">dataSet</span><span class="o">.</span><span class="na">toRows</span><span class="o">())</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValues</span><span class="o">()));</span>
</pre></div>


<p>and we can see that only the second record will be printed, with the values we inserted plus an additional value (the <code>_id</code> field that MongoDB creates automatically if none is supplied).</p>
<p>In order to run this example, the easiest solution is to download and run a MongoDB Docker image:</p>
<div class="highlight"><pre><span></span>$ docker pull mongo
$ docker run -p <span class="m">27017</span>:27017 mongo
</pre></div>


<p>If this is not an option, MongoDB can be installed manually following the instructions <a href="https://www.mongodb.com/download-center/community">here</a>.</p>
<p>Other data sources can be connected to and used in a similar fashion.</p>
<h3>Apache Membrane</h3>
<p>A fantastic and little known addition to MetaModel is its subproject <a href="https://cwiki.apache.org/confluence/display/METAMODEL/Membrane">Membrane</a>. Membrane is essentially a <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> Web service that can be used to manage and query different data sources <em>live</em> by adding them to <em>"tenants"</em> (which are basically independent contexts, each with its own connections to any number of data sources).</p>
<p>In order to run Membrane, we should clone the repository and build it:</p>
<div class="highlight"><pre><span></span>$ git clone https://github.com/apache/metamodel-membrane
$ mvn clean install
</pre></div>


<p>Since it has many dependencies, the building process will take a while. When the build is ready, we can run it with the following command:</p>
<div class="highlight"><pre><span></span>$ java -server -jar undertow/target/membrane-undertow-server.jar
</pre></div>


<p>The server will now run on port 8080, and we can submit requests to it by using <code>curl</code> or any REST client such as <a href="https://www.getpostman.com/">Postman</a>, <a href="https://install.advancedrestclient.com/">Advanced REST Client</a>, <a href="https://restlet.com/modules/client/">Restlet client</a>, etc.</p>
<hr>
<blockquote>
<p>If you are using Docker, you can use cool API description tools such as <a href="https://swagger.io/tools/swagger-ui/">Swagger UI</a> or <a href="https://github.com/Rebilly/ReDoc">ReDoc</a>; they can both be easily installed with <code>docker pull</code> and run with <code>docker run</code>, making sure to use a port different from 8080 where Membrane is running, and to use the Membrane-generated <code>swagger.json</code> as the API specification:</p>
<div class="highlight"><pre><span></span>$ docker pull redocly/redoc
$ docker run -p <span class="m">8000</span>:80 -e <span class="nv">SPEC_URL</span><span class="o">=</span>http://localhost:8080/swagger.json redocly/redoc
</pre></div>


<p>In order to call Membrane from such services, though, <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing#Request_headers">CORS headers</a> have to be enabled; I sent a <a href="https://github.com/apache/metamodel-membrane/pull/22">pull request</a> to add this capability with the help of a <code>MEMBRANE_ENABLE_CORS</code> variable, so that the server can be run with:</p>
<div class="highlight"><pre><span></span>$ <span class="nv">MEMBRANE_ENABLE_CORS</span><span class="o">=</span><span class="nb">true</span> java -server -jar undertow/target/membrane-undertow-server.jar
</pre></div>


</blockquote>
<hr>
<p>Having the server running, we can try out the endpoints. Let's first of all create a tenant:</p>
<div class="highlight"><pre><span></span>$ curl -X PUT http://localhost:8080/my-tenant
</pre></div>


<p>We will now add our first data source, for instance a CSV file:</p>
<div class="highlight"><pre><span></span>$ curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT http://localhost:8080/my-tenant/my-csv -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;type&quot;: &quot;csv&quot;,</span>
<span class="s1">  &quot;resource&quot;: &quot;/tmp/example.csv&quot;,</span>
<span class="s1">  &quot;quote-char&quot;: &quot;\&quot;&quot;,</span>
<span class="s1">  &quot;separator-char&quot;: &quot;,&quot;,</span>
<span class="s1">  &quot;escape-char&quot;: &quot;\\&quot;,</span>
<span class="s1">  &quot;encoding&quot;: &quot;UTF-8&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>


<p>and we will get a response like the following:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;datasource&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-csv&quot;</span><span class="p">,</span>
    <span class="nt">&quot;tenant&quot;</span><span class="p">:</span> <span class="s2">&quot;my-tenant&quot;</span><span class="p">,</span>
    <span class="nt">&quot;updateable&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;query_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;/my-tenant/my-csv/query&quot;</span><span class="p">,</span>
    <span class="nt">&quot;schemas&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;information_schema&quot;</span><span class="p">,</span>
        <span class="nt">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;/my-tenant/my-csv/s/information_schema&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
        <span class="nt">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;/my-tenant/my-csv/s/resources&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>which will show some endpoints we can explore. The <code>/my-tenant/my-csv/s/information_schema</code> endpoint, for instance, shows the structure of a generic information schema; the <code>/my-tenant/my-csv/s/resources</code> endpoint, instead, shows the tables of our datasource - we can, for instance, get the metadata on the CSV file by exploring the <code>/my-tenant/my-csv/s/resources/t/default_table</code> endpoint. The most interesting endpoint, though, is probably <code>/my-tenant/my-csv/query</code>: we can submit a query as a GET parameter and immediately get results. For instance, we can call:</p>
<div class="highlight"><pre><span></span>$ curl -G <span class="s2">&quot;http://localhost:8080/my-tenant/my-csv/query&quot;</span> --data-urlencode <span class="s2">&quot;sql=SELECT * FROM default_table&quot;</span>
</pre></div>


<p>to get the whole content of the example CSV file. (Here, <code>-G</code> and <code>--data-urlencode</code> are used in order to URL-encode the <code>sql</code> parameter and still send it as a <code>GET</code> request.)</p>
<h3>Conclusions</h3>
<p>MetaModel is an easy-to-use and extendable tool that makes it easier to integrate multiple data sources programmatically (even at runtime, with its subproject Membrane). I believe it is worth exploring further since it can simplify what is usually a chore, although most likely it cannot easily scale.</p>
<p>Just a note of caution: since the project is at a very early stage, there are no strict security measures and the Membrane API could expose information that should not be exposed. Take this into account before releasing anything!</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
    <li class="list-inline-item"><a href="https://apothem.blog/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://apothem.blog/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="https://apothem.blog/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>